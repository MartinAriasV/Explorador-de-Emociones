{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "name": {
          "type": "string",
          "description": "The user's display name."
        },
        "avatar": {
          "type": "string",
          "description": "The user's chosen avatar (e.g., an emoji or image URL)."
        }
      },
      "required": [
        "id",
        "name",
        "avatar"
      ]
    },
    "Emotion": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Emotion",
      "type": "object",
      "description": "Represents an emotion that a user can track in their diary.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Emotion entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the emotion (e.g., 'Joy', 'Sadness')."
        },
        "icon": {
          "type": "string",
          "description": "An emoji or other icon representing the emotion."
        },
        "color": {
          "type": "string",
          "description": "A color associated with the emotion (e.g., '#FF0000' for red)."
        },
        "definition": {
          "type": "string",
          "description": "A user-defined definition of what this emotion means to them. (Optional and can be null)"
        },
        "example": {
          "type": "string",
          "description": "An example situation or feeling related to the emotion. (Optional and can be null)"
        }
      },
      "required": [
        "id",
        "name",
        "icon",
        "color"
      ]
    },
    "DiaryEntry": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "DiaryEntry",
      "type": "object",
      "description": "Represents a single diary entry recording a user's emotion and experience.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the DiaryEntry entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N DiaryEntry)"
        },
        "emotionId": {
          "type": "string",
          "description": "Reference to Emotion. (Relationship: Emotion 1:N DiaryEntry)"
        },
        "date": {
          "type": "string",
          "description": "The date of the diary entry.",
          "format": "date-time"
        },
        "text": {
          "type": "string",
          "description": "A textual description of the user's experience and feelings."
        }
      },
      "required": [
        "id",
        "userId",
        "emotionId",
        "date",
        "text"
      ]
    }
  },
  "auth": {
    "providers": [
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information, owned by the user.  No denormalized authorization fields required as it is path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/diaryEntries/{diaryEntryId}",
        "definition": {
          "entityName": "DiaryEntry",
          "schema": {
            "$ref": "#/backend/entities/DiaryEntry"
          },
          "description": "Stores diary entries for a specific user. No denormalized authorization fields required as it is path-based ownership.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "diaryEntryId",
              "description": "The unique identifier of the diary entry."
            }
          ]
        }
      },
      {
        "path": "/emotions/{emotionId}",
        "definition": {
          "entityName": "Emotion",
          "schema": {
            "$ref": "#/backend/entities/Emotion"
          },
          "description": "Stores predefined emotions that can be used in diary entries. No denormalized authorization fields required as these documents share the same security posture.",
          "params": [
            {
              "name": "emotionId",
              "description": "The unique identifier of the emotion."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to address the 'auth/operation-not-allowed' error, which typically indicates that the Firebase Authentication service is not enabled for the project or that sign-in methods are not properly configured. The structure focuses on storing user-related data in a way that simplifies security rules and ensures data integrity, adhering to the core design principles.\n\n**Authorization Independence (CRITICAL):** All data is owned by individual users, eliminating the need for hierarchical authorization checks. Diary entries are stored under the user's ID, making authorization rules straightforward based on `request.auth.uid`.\n\n**Clarity of Intent (Debuggability):** The data structure clearly reflects the intent of ownership and relationships. The path `/users/{userId}/diaryEntries/{diaryEntryId}` explicitly shows that diary entries belong to a specific user.\n\n**DBAC (No Custom Claims):** User roles are not used; authentication relies solely on `request.auth.uid` to determine access based on path ownership.\n\n**QAPs (Rules are not Filters):** The structure supports secure `list` operations. Listing diary entries is limited to the entries owned by the authenticated user, preventing unauthorized data access. Emotion documents are segregated and do not require filtering.\n\n**Invariants:** The structure supports the integrity of ownership by directly linking diary entries to user IDs. Timestamps within diary entries and denormalized data (if any) maintain consistency.\n\nThe structure uses path-based ownership for private data, specifically for user profiles and diary entries. This approach simplifies security rules and enforces clear ownership. There is no collaborative data, and thus no membership maps are used.\n\nTo resolve the 'auth/operation-not-allowed' error, ensure the Firebase Authentication service is enabled and the necessary sign-in methods (e.g., email/password, Google Sign-In) are activated in the Firebase Console."
  }
}
    